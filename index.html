<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Matt's Magical MIDI Machine</title>
  <style>
    :root{
      color-scheme: dark;
      --bg0:#050611;
      --bg1:#0b0f2a;
      --stroke:rgba(140,185,255,.22);
      --stroke2:rgba(255,255,255,.10);
      --text:#eef1ff;
      --muted:#b7bbdd;

      --neonA:#00f5ff;
      --neonB:#b56bff;
      --neonC:#39ff14;
      --neonD:#ff2bd6;

      --shadow: 0 18px 60px rgba(0,0,0,.58);
      --glowA: 0 0 26px rgba(0,245,255,.30);
      --glowB: 0 0 28px rgba(181,107,255,.25);
      --glowC: 0 0 26px rgba(57,255,20,.22);
      --glowD: 0 0 22px rgba(255,43,214,.22);

      --card: rgba(10,14,40,.62);
      --card2: rgba(6,9,25,.65);

      --kbdStartMidi: 48;
      --kbdKeyCount: 25;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 700px at 30% 15%, rgba(0,245,255,.10), transparent 60%),
        radial-gradient(900px 600px at 70% 25%, rgba(181,107,255,.09), transparent 60%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,43,214,.07), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{max-width:920px;margin:0 auto;padding:18px 16px 40px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;border:1px solid var(--stroke); border-radius:18px;
      background:linear-gradient(180deg, rgba(15,18,48,.72), rgba(10,12,30,.62));
      box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;user-select:none}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:
        radial-gradient(12px 12px at 30% 35%, var(--neonA), transparent 70%),
        radial-gradient(14px 14px at 70% 40%, var(--neonB), transparent 70%),
        radial-gradient(10px 10px at 55% 70%, var(--neonD), transparent 70%),
        rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--glowA), var(--glowB);
    }
    .brand h1{margin:0;font-size:14px;letter-spacing:.4px}
    .brand .sub{margin:0;color:var(--muted);font-size:12px}

    .status{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;
      font-size:12px;color:var(--muted);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.05);
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.20)}
    .dot.on{background:var(--neonA);box-shadow:0 0 18px rgba(0,245,255,.45)}

    .stack{margin-top:14px;display:flex;flex-direction:column;gap:14px}

    .card{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;inset:-2px;
      background:
        radial-gradient(600px 240px at 20% 0%, rgba(0,245,255,.12), transparent 65%),
        radial-gradient(520px 240px at 80% 0%, rgba(181,107,255,.10), transparent 65%),
        radial-gradient(520px 260px at 50% 100%, rgba(255,43,214,.08), transparent 60%);
      pointer-events:none;
      filter:saturate(1.2);
    }
    .card > *{position:relative}

    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .cardTitle{display:flex;flex-direction:column;gap:2px}
    .cardTitle b{font-size:13px;letter-spacing:.35px}
    .cardTitle span{font-size:12px;color:var(--muted)}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    select, button{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      outline:none;
    }
    select{
      padding-right:34px;
      background: rgba(170,170,170,.20);
      border-color: rgba(255,255,255,.14);
    }
    select:focus{
      box-shadow: 0 0 0 2px rgba(255,255,255,.10), var(--glowA);
    }
    select option{background:#2b2c33;color:#eef1ff}

    button{cursor:pointer;transition: transform .06s ease, filter .12s ease;user-select:none}
    button:active{transform: translateY(1px)}
    button.primary{border-color: rgba(0,245,255,.28);box-shadow: var(--glowA)}
    button.ghost{background: rgba(255,255,255,.03)}
    button.hot{border-color: rgba(255,43,214,.28);box-shadow: var(--glowD)}
    .controls{padding:12px}

    .knobRowWrap{display:flex;justify-content:center;width:100%}
    .knobRow{
      display:flex;justify-content:center;align-items:flex-start;
      gap:10px;flex-wrap:nowrap;overflow-x:auto;
      padding:2px 2px 6px;max-width:100%;
    }
    .knobRow::-webkit-scrollbar{height:8px}
    .knobRow::-webkit-scrollbar-thumb{background: rgba(255,255,255,.10);border-radius:999px}
    .knob{width:86px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.05);padding:8px 8px 10px;flex:0 0 auto;user-select:none;touch-action:none}
    .knobTop{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:6px;color: rgba(255,255,255,.88);font-size:10px;font-weight:800;letter-spacing:.2px;white-space:nowrap}
    .knobTop span:first-child{overflow:hidden;text-overflow:ellipsis;max-width:56px}
    .dial{
      width:60px;height:60px;margin:0 auto;border-radius:16px;border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(20px 20px at 35% 30%, rgba(0,245,255,.14), transparent 70%),
        radial-gradient(20px 20px at 70% 55%, rgba(181,107,255,.12), transparent 70%),
        rgba(0,0,0,.28);
      display:grid;place-items:center;position:relative;box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      cursor:ns-resize;
    }
    .dial::after{
      content:"";width:4px;height:42%;border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.20));
      position:absolute;top:16%;left:50%;
      transform-origin: 50% 100%;
      transform: translateX(-50%) rotate(var(--rot, -135deg));
      box-shadow: 0 0 14px rgba(0,245,255,.18);
      opacity:.95;
    }
    .val{margin-top:7px;height:8px;border-radius:999px;background: rgba(255,255,255,.07);overflow:hidden;border:1px solid rgba(255,255,255,.08)}
    .val > i{display:block;height:100%;width: calc(var(--p, 0) * 1%);background: linear-gradient(90deg, rgba(0,245,255,.80), rgba(181,107,255,.70));box-shadow: 0 0 18px rgba(0,245,255,.12)}
    @media (max-width: 520px){ .knob{width:78px} .dial{width:54px;height:54px} }

    .mp{display:grid;grid-template-columns: 1fr 1fr;gap:10px;align-items:stretch;margin-top:10px}
    .sliderBox{border-radius:16px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.05);padding:10px;user-select:none;touch-action:none}
    .sliderBox header{display:flex;align-items:center;justify-content:space-between;font-size:11px;font-weight:800;letter-spacing:.25px;color: rgba(255,255,255,.88);margin-bottom:8px}
    .slider{height:18px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.22);overflow:hidden;position:relative;cursor:ew-resize}
    .slider > i{position:absolute;left:0;top:0;bottom:0;width: calc(var(--p, 50) * 1%);background: linear-gradient(90deg, rgba(255,43,214,.60), rgba(0,245,255,.60));box-shadow: 0 0 22px rgba(255,43,214,.14)}

    .btnGrid{display:grid;grid-template-columns: repeat(3, 1fr);gap:10px;margin-top:10px}
    .mBtn{border-radius:14px;padding:12px 10px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);cursor:pointer;user-select:none;font-size:12px;font-weight:800;letter-spacing:.2px;text-align:center;transition: transform .06s ease, filter .12s ease, box-shadow .12s ease}
    .mBtn.active{border-color: rgba(255,43,214,.28);box-shadow: 0 0 0 2px rgba(255,43,214,.18), 0 0 26px rgba(255,43,214,.14);filter: brightness(1.04)}
    .mBtn:active{transform: translateY(1px)}

    .pads{display:grid;grid-template-columns: repeat(4, 1fr);gap:10px}
    @media (max-width: 520px){ .pads{grid-template-columns: repeat(2, 1fr)} }
    .pad{
      min-height:62px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:center;text-align:center;
      padding:10px 8px;cursor:pointer;user-select:none;position:relative;overflow:hidden;
      transition: transform .10s ease, filter .12s ease, box-shadow .12s ease;
      font-size:12px;font-weight:800;letter-spacing:.25px;color: rgba(255,255,255,.92);
      touch-action:none;
    }
    .pad::before{
      content:"";position:absolute; inset:-2px;
      background:
        radial-gradient(120px 80px at 30% 30%, rgba(57,255,20,.16), transparent 60%),
        radial-gradient(140px 90px at 70% 60%, rgba(0,245,255,.14), transparent 60%);
      opacity:.75;pointer-events:none;
    }
    .pad::after{
      content:"";position:absolute;width:8px;height:8px;border-radius:999px;
      left:var(--rx,50%);top:var(--ry,50%);
      transform: translate(-50%,-50%) scale(0.6);
      background: radial-gradient(circle, rgba(255,255,255,.65), rgba(255,255,255,0) 60%);
      opacity:0;pointer-events:none;
    }
    .pad.active{
      box-shadow:
        0 0 0 2px rgba(57,255,20,.20),
        0 0 34px rgba(57,255,20,.20),
        0 0 34px rgba(0,245,255,.12),
        inset 0 0 0 1px rgba(255,255,255,.06);
      filter: brightness(1.10);
      animation: padThump .12s ease-out;
    }
    .pad.pulse::after{animation: padRipple .22s ease-out}
    .pad small{display:block;font-size:10px;font-weight:700;opacity:.82;margin-top:4px;color: rgba(255,255,255,.84)}
    .pad:active{transform: translateY(1px)}
    @keyframes padThump{0%{transform: scale(1)}55%{transform: scale(0.96)}100%{transform: scale(1)}}
    @keyframes padRipple{0%{opacity:.75; transform: translate(-50%,-50%) scale(0.6)}100%{opacity:0; transform: translate(-50%,-50%) scale(6.0)}}

    .kbdWrap{padding:12px}
    .kbd{
      position:relative;height:190px;border:1px solid rgba(255,255,255,.10);
      border-radius:16px;background: rgba(0,0,0,.26);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 0 28px rgba(0,245,255,.07);
      user-select:none;touch-action:none;
    }
    .whiteKeys{position:absolute; inset:0;display:grid;grid-auto-flow:column;grid-auto-columns:1fr;gap:2px;padding:10px;align-items:stretch}
    .wkey{
      border-radius:10px;background: linear-gradient(180deg, rgba(243,244,255,.92), rgba(215,220,255,.92));
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.18);
      border:1px solid rgba(0,0,0,.18);
      display:flex;align-items:flex-end;justify-content:center;padding-bottom:10px;
      color: rgba(10,12,24,.88);font-weight:800;font-size:11px;letter-spacing:.2px;
      transition: filter .08s ease, transform .08s ease, box-shadow .12s ease;
      position:relative;overflow:hidden;
    }
    .wkey::after{
      content:"";position:absolute; inset:-2px;
      background: radial-gradient(140px 90px at 50% 85%, rgba(0,245,255,.30), transparent 62%);
      opacity:0;transition: opacity .10s ease;pointer-events:none;
    }
    .wkey.active{
      transform: translateY(1px) scale(0.995);
      box-shadow:
        inset 0 -10px 18px rgba(0,0,0,.18),
        0 0 0 2px rgba(0,245,255,.50),
        0 0 56px rgba(0,245,255,.45),
        0 0 90px rgba(0,245,255,.20);
      filter: brightness(1.18) saturate(1.35);
      animation: keyPulse .14s ease-out;
    }
    .wkey.active::after{opacity:1}

    .blackKeys{position:absolute; inset:0; pointer-events:none}
    .bkey{
      position:absolute;top:10px;width:34px;height:110px;border-radius:10px;
      background: linear-gradient(180deg, rgba(10,12,24,.96), rgba(0,0,0,.94));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 24px rgba(0,0,0,.55);
      pointer-events:auto;
      display:flex;align-items:flex-end;justify-content:center;padding-bottom:10px;
      color: rgba(240,242,255,.90);font-weight:800;font-size:10px;
      transition: filter .08s ease, transform .08s ease, box-shadow .12s ease;
      overflow:hidden;
    }
    .bkey::after{
      content:"";position:absolute; inset:-2px;
      background: radial-gradient(120px 80px at 50% 85%, rgba(181,107,255,.32), transparent 62%);
      opacity:0;transition: opacity .10s ease;pointer-events:none;
    }
    .bkey.active{
      transform: translateY(1px) scale(0.995);
      box-shadow:
        0 14px 24px rgba(0,0,0,.55),
        0 0 0 2px rgba(181,107,255,.52),
        0 0 52px rgba(181,107,255,.40),
        0 0 84px rgba(181,107,255,.18);
      filter: brightness(1.18) saturate(1.35);
      animation: keyPulse .14s ease-out;
    }
    .bkey.active::after{opacity:1}
    @keyframes keyPulse{0%{transform: translateY(0) scale(1)}55%{transform: translateY(1px) scale(0.985)}100%{transform: translateY(1px) scale(0.995)}}

    .splash{
      position:fixed; inset:0;display:grid; place-items:center;z-index:999;padding:20px;
      background:
        radial-gradient(1200px 700px at 30% 15%, rgba(0,245,255,.14), transparent 60%),
        radial-gradient(900px 600px at 70% 25%, rgba(181,107,255,.12), transparent 60%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,43,214,.10), transparent 60%),
        linear-gradient(180deg, #03040f, #080a1f);
    }
    .sCard{
      width:min(740px, 96vw);
      border-radius:22px;border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,40,.70);
      box-shadow: 0 24px 90px rgba(0,0,0,.65);
      overflow:hidden;position:relative;
    }
    .sTop{padding:18px 18px 10px}
    .sTop h2{margin:0 0 6px;font-size:16px;letter-spacing:.35px}
    .sTop p{margin:0;color:var(--muted);font-size:12px;line-height:1.4}
    .sBody{padding:12px 18px 18px; display:grid; gap:10px}
    .sRow{display:flex; gap:10px; flex-wrap:wrap}
    .sRow button{flex:1; min-width: 220px}
    .sFoot{padding:0 18px 18px; color:rgba(255,255,255,.70); font-size:11px; line-height:1.4}
    .kbdHint{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .tag{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.78);
      font-size:11px;
      user-select:none;
    }

    .instructions{
      padding:16px;
      line-height:1.45;
      color: rgba(255,255,255,.88);
    }
    .instructions h3{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.3px;
    }
    .instructions ul{
      margin:8px 0 0 18px;
      padding:0;
      color: rgba(255,255,255,.82);
      font-size:12px;
    }
    .instructions li{margin:6px 0}
    .footer{
      margin-top:14px;
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.64);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .footer b{color: rgba(255,255,255,.82)}
  </style>
</head>
<body>
  <div id="splash" class="splash">
    <div class="sCard">
      <div class="sTop">
        <h2>Matt’s Magical MIDI Machine</h2>
        <p>Pick MIDI, or just audio + typing keyboard. Everything lights up to match what you press.</p>
      </div>
      <div class="sBody">
        <div class="sRow">
          <button id="startMidi" class="primary">Start with MIDI</button>
          <button id="startTyping" class="ghost">Start with Audio + Typing Keyboard</button>
        </div>
        <div class="kbdHint">
          <span class="tag">Typing notes: A W S E D F T G Y H U J K</span>
          <span class="tag">Typing pads: 1 2 3 4 / Q W E R / A S D F / Z X C V</span>
          <span class="tag">Octave: [ ]</span>
        </div>
      </div>
      <div class="sFoot">Tip: Chrome/Edge supports WebMIDI. Audio starts after a click.</div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Matt’s Magical MIDI Machine</h1>
          <p class="sub">knobs → pads → keys · one column stack</p>
        </div>
      </div>

      <div class="status">
        <div class="pill"><span id="midiDot" class="dot"></span> MIDI</div>
        <div class="pill"><span id="audioDot" class="dot"></span> Audio</div>

        <div class="pill">
          <span>Input</span>
          <select id="midiInSel" title="MIDI Input"></select>
        </div>

        <div class="pill">
          <span>Sound</span>
          <select id="soundSel" title="Keyboard Sound Bank"></select>
        </div>

        <div class="pill">
          <span>Kit</span>
          <select id="kitSel" title="Drum Kit">
            <option value="neon">Neon Kit</option>
            <option value="garage">Garage Kit</option>
            <option value="glitch">Glitch Kit</option>
          </select>
        </div>

        <div class="pill">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input id="loudToggle" type="checkbox"/>
            LOUD
          </label>
        </div>

        <div class="pill"><button id="panic" class="hot" title="Stop all sound">Panic</button></div>
      </div>
    </div>

    <div class="stack">
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">
            <b>Knobs</b>
            <span>mouse drag up/down</span>
          </div>
        </div>
        <div class="controls">
          <div class="knobRowWrap">
            <div id="knobs" class="knobRow"></div>
          </div>

          <div class="mp">
            <div class="sliderBox">
              <header><span>Pitch</span><span id="pitchVal">0</span></header>
              <div id="pitch" class="slider" style="--p:50"><i></i></div>
            </div>
            <div class="sliderBox">
              <header><span>Mod</span><span id="modVal">0</span></header>
              <div id="mod" class="slider" style="--p:0"><i></i></div>
            </div>
          </div>

          <div class="btnGrid">
            <div id="btnPlay" class="mBtn">Play</div>
            <div id="btnStop" class="mBtn">Stop</div>
            <div id="btnRec" class="mBtn">Rec</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">
            <b>Pads</b>
            <span>drums only</span>
          </div>
        </div>
        <div class="controls">
          <div id="pads" class="pads"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">
            <b>Keyboard</b>
            <span>notes only</span>
          </div>
          <div class="row">
            <button id="octDown" class="ghost" title="Octave down">Oct −</button>
            <button id="octUp" class="ghost" title="Octave up">Oct +</button>
          </div>
        </div>
        <div class="kbdWrap">
          <div id="kbd" class="kbd">
            <div id="whiteKeys" class="whiteKeys"></div>
            <div id="blackKeys" class="blackKeys"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="instructions">
          <h3>How to Use It</h3>
          <ul>
            <li><b>Start</b>: choose “Start with MIDI” (WebMIDI) or “Audio + Typing Keyboard”.</li>
            <li><b>MIDI Input</b>: pick your device in the Input dropdown.</li>
            <li><b>Keys</b>: pressing MIDI notes lights the onscreen keyboard. Mouse also plays notes.</li>
            <li><b>Pads</b>: pads are <b>drums only</b>. They animate on hit. Mouse also triggers them.</li>
            <li><b>Sound</b>: selects the keyboard synth sound bank (pads stay drums).</li>
            <li><b>Kit</b>: changes the drum kit labels and drum “character”.</li>
            <li><b>LOUD</b>: boosts drums/pads and adds a gentle limiter so it hits harder without hard clipping.</li>
            <li><b>Octave</b>: click Oct − / Oct +, or use <b>[</b> and <b>]</b> on your typing keyboard.</li>
            <li><b>Typing Notes</b>: A W S E D F T G Y H U J K (chromatic run).</li>
            <li><b>Typing Pads</b>: 1 2 3 4 / Q W E R / A S D F / Z X C V.</li>
            <li><b>Panic</b>: stops all sound immediately (also works with <b>Esc</b>).</li>
          </ul>
        </div>
        <div class="footer">
          <div><b>Matt’s Magical MIDI Machine</b> · browser synth + MIDI mirror</div>
          <div>Tip: if MIDI doesn’t show, use Chrome/Edge and refresh after plugging the device in.</div>
        </div>
      </div>

    </div>
  </div>

  <script>
  (() => {
    const MAP = {
      padNotes: Array.from({length:16}, (_,i)=>36+i),
      knobCCs: [21,22,23,24,25,26,27,28],
      modCC: 1,
      play:  { type:"cc", number: 115 },
      stop:  { type:"cc", number: 116 },
      rec:   { type:"cc", number: 117 },
    };

    const KNOB_LABELS = [
      "Volume","Filter","Resonance","Attack","Decay","Release","Drum Tone","Drum Decay"
    ];

    const SOUND_BANK = [
      {id:"sine",     name:"Sine (Clean)"},
      {id:"tri",      name:"Triangle (Soft)"},
      {id:"square",   name:"Square (Hollow)"},
      {id:"saw",      name:"Saw (Bright)"},
      {id:"supersaw", name:"SuperSaw (Wide)"},
      {id:"pwm",      name:"PWM Lead (Buzzy)"},
      {id:"fm_bell",  name:"FM Bell (Shiny)"},
      {id:"epiano",   name:"EPiano (Tines)"},
      {id:"organ",    name:"Organ (Drawbars)"},
      {id:"strings",  name:"Strings Pad (Warm)"},
      {id:"voxpad",   name:"Vox Pad (Oooh)"},
      {id:"pluck",    name:"Pluck (Snap)"},
      {id:"bass",     name:"Bass (Round)"},
      {id:"sub",      name:"Sub Bass (Deep)"},
      {id:"reese",    name:"Reese (Growl)"},
      {id:"brass",    name:"Brass-ish (Stab)"},
      {id:"glass",    name:"Glass (Ping)"},
      {id:"noiselead",name:"Noise Lead (Edge)"},
      {id:"chirp",    name:"Chirp Lead (8bit)"}
    ];

    let selectedSound = "pluck";
    let loudMode = false;

    let midiAccess=null, midiIn=null;
    let audioCtx=null, master=null;
    let isAudioOn=false;

    let octaveOffset=0;
    const pressedNotes=new Set();
    const pressedPads=new Set();

    const splash=document.getElementById('splash');
    const startMidiBtn=document.getElementById('startMidi');
    const startTypingBtn=document.getElementById('startTyping');

    const midiDot=document.getElementById('midiDot');
    const audioDot=document.getElementById('audioDot');
    const midiInSel=document.getElementById('midiInSel');
    const soundSel=document.getElementById('soundSel');
    const kitSel=document.getElementById('kitSel');

    const whiteKeysEl=document.getElementById('whiteKeys');
    const blackKeysEl=document.getElementById('blackKeys');
    const kbdEl=document.getElementById('kbd');

    const padsEl=document.getElementById('pads');
    const knobsEl=document.getElementById('knobs');

    const pitchEl=document.getElementById('pitch');
    const modEl=document.getElementById('mod');
    const pitchValEl=document.getElementById('pitchVal');
    const modValEl=document.getElementById('modVal');

    const btnPlay=document.getElementById('btnPlay');
    const btnStop=document.getElementById('btnStop');
    const btnRec=document.getElementById('btnRec');

    const octDown=document.getElementById('octDown');
    const octUp=document.getElementById('octUp');
    const panicBtn=document.getElementById('panic');
    const loudToggle=document.getElementById('loudToggle');

    const NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const noteName=(n)=>`${NOTE_NAMES[(n%12+12)%12]}${Math.floor(n/12)-1}`;
    const isBlack=(n)=>[1,3,6,8,10].includes((n%12+12)%12);

    const CSS_START=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--kbdStartMidi'))||48;
    const CSS_COUNT=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--kbdKeyCount'))||25;
    const KEY_RANGE={start:CSS_START,count:CSS_COUNT};

    const keyElsByNote=new Map();
    const whiteOrderNotes=[];
    const blackNotes=[];

    const KITS={
      neon:[
        {name:"Kick",type:"kick"},{name:"Snare",type:"snare"},{name:"Clap",type:"clap"},{name:"Closed Hat",type:"hatC"},
        {name:"Open Hat",type:"hatO"},{name:"Tom Low",type:"tomL"},{name:"Tom Mid",type:"tomM"},{name:"Tom High",type:"tomH"},
        {name:"Rim",type:"rim"},{name:"Perc",type:"perc"},{name:"Crash",type:"crash"},{name:"Ride",type:"ride"},
        {name:"Vox Chop",type:"vox"},{name:"Zap",type:"zap"},{name:"Noise Hit",type:"noise"},{name:"Sub Drop",type:"subdrop"}
      ],
      garage:[
        {name:"Kick (Thud)",type:"kick2"},{name:"Snare (Dry)",type:"snare2"},{name:"Clap (Room)",type:"clap2"},{name:"Hat (Tight)",type:"hatC2"},
        {name:"Hat (Loose)",type:"hatO2"},{name:"Tom (Floor)",type:"tomL2"},{name:"Tom (Mid)",type:"tomM2"},{name:"Tom (High)",type:"tomH2"},
        {name:"Rim (Click)",type:"rim2"},{name:"Cowbell",type:"cow"},{name:"Crash",type:"crash2"},{name:"Ride",type:"ride2"},
        {name:"Shaker",type:"shaker"},{name:"Tamb",type:"tamb"},{name:"Snap",type:"snap"},{name:"Stomp",type:"stomp"}
      ],
      glitch:[
        {name:"Kick (Bit)",type:"gkick"},{name:"Snare (Bit)",type:"gsnare"},{name:"Tick",type:"gtick"},{name:"Hat (Grain)",type:"ghat"},
        {name:"Hat (Air)",type:"ghat2"},{name:"Bloop",type:"bloop"},{name:"Bleep",type:"bleep"},{name:"Chirp",type:"chirp"},
        {name:"Click",type:"click"},{name:"Pop",type:"pop"},{name:"Glitch Hit",type:"glitch"},{name:"Reverse",type:"reverse"},
        {name:"Laser",type:"laser"},{name:"Burst",type:"burst"},{name:"Static",type:"static"},{name:"Drop",type:"drop"}
      ]
    };
    let currentKitKey="neon";

    const padElsByNote=new Map();
    const knobElsByCC=new Map();
    const knobVals=new Map();
    let pitchBend=0;
    let modWheel=0;

    const activeVoices=new Map();

    function buildSoundBank(){
      soundSel.innerHTML="";
      SOUND_BANK.forEach(s=>{
        const o=document.createElement("option");
        o.value=s.id;
        o.textContent=s.name;
        soundSel.appendChild(o);
      });
      soundSel.value=selectedSound;
    }

    function buildKeyboard(){
      whiteKeysEl.innerHTML='';
      blackKeysEl.innerHTML='';
      keyElsByNote.clear();
      whiteOrderNotes.length=0;
      blackNotes.length=0;

      for(let n=KEY_RANGE.start;n<KEY_RANGE.start+KEY_RANGE.count;n++){
        if(!isBlack(n)) whiteOrderNotes.push(n);
        else blackNotes.push(n);
      }

      for(const n of whiteOrderNotes){
        const el=document.createElement('div');
        el.className='wkey';
        el.dataset.note=String(n);
        el.textContent=noteName(n);
        el.addEventListener('pointerdown',(e)=>{e.preventDefault();keyDown(n,0.9);el.setPointerCapture(e.pointerId);});
        el.addEventListener('pointerup',(e)=>{e.preventDefault();keyUp(n);});
        el.addEventListener('pointerleave',(e)=>{if(e.buttons) keyUp(n);});
        whiteKeysEl.appendChild(el);
        keyElsByNote.set(n,el);
      }

      for(const n of blackNotes){
        const el=document.createElement('div');
        el.className='bkey';
        el.dataset.note=String(n);
        el.textContent=noteName(n);
        el.addEventListener('pointerdown',(e)=>{e.preventDefault();keyDown(n,0.9);el.setPointerCapture(e.pointerId);});
        el.addEventListener('pointerup',(e)=>{e.preventDefault();keyUp(n);});
        el.addEventListener('pointerleave',(e)=>{if(e.buttons) keyUp(n);});
        blackKeysEl.appendChild(el);
        keyElsByNote.set(n,el);
      }
      positionBlackKeys();
    }

    function positionBlackKeys(){
      const rect=kbdEl.getBoundingClientRect();
      const pad=10;
      const innerW=rect.width-pad*2;
      const whiteW=innerW/whiteOrderNotes.length;
      const whiteIndex=new Map();
      whiteOrderNotes.forEach((n,i)=>whiteIndex.set(n,i));

      for(const el of blackKeysEl.children){
        const n=parseInt(el.dataset.note,10);
        let prev=n-1; while(prev>=KEY_RANGE.start && isBlack(prev)) prev--;
        let next=n+1; while(next<KEY_RANGE.start+KEY_RANGE.count && isBlack(next)) next++;
        const pi=whiteIndex.get(prev);
        const ni=whiteIndex.get(next);

        let x;
        if(pi!=null && ni!=null) x=pad+(pi+1)*whiteW-(el.offsetWidth/2);
        else if(pi!=null) x=pad+(pi+0.85)*whiteW;
        else if(ni!=null) x=pad+(ni-0.15)*whiteW-(el.offsetWidth/2);
        else x=pad;

        el.style.left=`${x}px`;
      }
    }
    window.addEventListener('resize', positionBlackKeys);

    function buildPads(){
      padsEl.innerHTML='';
      padElsByNote.clear();
      const kit=KITS[currentKitKey];
      MAP.padNotes.forEach((note,i)=>{
        const data=kit[i]||{name:`Pad ${i+1}`,type:"perc"};
        const el=document.createElement('div');
        el.className='pad';
        el.dataset.note=String(note);
        el.dataset.type=data.type;
        el.innerHTML=`<div>${data.name}<small>${noteName(note)}</small></div>`;
        el.addEventListener('pointerdown',(e)=>{e.preventDefault();padDown(note,1.0,e);el.setPointerCapture(e.pointerId);});
        el.addEventListener('pointerup',(e)=>{e.preventDefault();padUp(note);});
        el.addEventListener('pointerleave',(e)=>{if(e.buttons) padUp(note);});
        padsEl.appendChild(el);
        padElsByNote.set(note,el);
      });
    }

    function buildKnobs(){
      knobsEl.innerHTML='';
      knobElsByCC.clear();
      knobVals.clear();

      MAP.knobCCs.forEach((cc,i)=>{
        knobVals.set(cc,0);
        const name = KNOB_LABELS[i] || `Knob ${i+1}`;

        const box=document.createElement('div');
        box.className='knob';
        box.innerHTML=`
          <div class="knobTop"><span>${name}</span><span id="kLabel${cc}">0</span></div>
          <div class="dial" data-cc="${cc}" style="--rot:-135deg"></div>
          <div class="val" style="--p:0"><i></i></div>
        `;
        const dial=box.querySelector('.dial');
        const meter=box.querySelector('.val');
        const label=box.querySelector(`#kLabel${cc}`);
        let drag=null;

        dial.addEventListener('pointerdown',(e)=>{
          e.preventDefault();
          dial.setPointerCapture(e.pointerId);
          drag={id:e.pointerId,y:e.clientY,start:knobVals.get(cc)||0};
        });
        dial.addEventListener('pointermove',(e)=>{
          if(!drag||drag.id!==e.pointerId) return;
          const dy=drag.y-e.clientY;
          const delta=Math.round(dy*0.4);
          setKnob(cc, clamp(drag.start+delta,0,127));
        });
        dial.addEventListener('pointerup',()=>{drag=null;});

        knobElsByCC.set(cc,{dial,meter,label});
        knobsEl.appendChild(box);
      });

      MAP.knobCCs.forEach(cc=>setKnob(cc,0));
    }

    function setKnob(cc,value){
      knobVals.set(cc,value);
      const ui=knobElsByCC.get(cc);
      if(ui){
        const p=(value/127)*100;
        const rot=-135+(270*(value/127));
        ui.dial.style.setProperty('--rot',`${rot}deg`);
        ui.meter.style.setProperty('--p',p.toFixed(2));
        ui.label.textContent=String(value);
      }
      if(isAudioOn) applyAudioFromKnobs();
    }

    function ensureAudio(){
      if(audioCtx) return;
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      master=audioCtx.createGain();
      master.gain.value=0.75;
      master.connect(audioCtx.destination);
    }

    function setAudioOn(on){
      ensureAudio();
      isAudioOn=on;
      audioDot.classList.toggle('on',on);
      if(on && audioCtx.state!=='running') audioCtx.resume().catch(()=>{});
      applyAudioFromKnobs();
    }

    function applyAudioFromKnobs(){
      if(!isAudioOn) return;
      const v=(knobVals.get(MAP.knobCCs[0])||0)/127;
      master.gain.value=0.10 + v*0.90;
    }

    const midiToFreq=(n)=>440*Math.pow(2,(n-69)/12);

    function setPitch(p){
      pitchBend=clamp(p,-1,1);
      const uiP=((pitchBend+1)/2)*100;
      pitchEl.style.setProperty('--p',uiP.toFixed(2));
      pitchValEl.textContent=pitchBend.toFixed(2);
      if(isAudioOn){
        for(const [note,v] of activeVoices.entries()){
          const f=midiToFreq(note)*Math.pow(2,pitchBend*(2/12));
          try{ v.oscA.frequency.setTargetAtTime(f,audioCtx.currentTime,0.005); }catch(_){}
          if(v.oscB) try{ v.oscB.frequency.setTargetAtTime(f*(v.detuneMul||1),audioCtx.currentTime,0.005); }catch(_){}
        }
      }
    }

    function setMod(v){
      modWheel=clamp(v,0,127);
      const uiP=(modWheel/127)*100;
      modEl.style.setProperty('--p',uiP.toFixed(2));
      modValEl.textContent=String(modWheel|0);
    }

    function bindSlider(el,onSet,mode){
      let drag=null;
      el.addEventListener('pointerdown',(e)=>{
        e.preventDefault();
        el.setPointerCapture(e.pointerId);
        drag={id:e.pointerId,r:el.getBoundingClientRect()};
        move(e);
      });
      el.addEventListener('pointermove',(e)=>{ if(drag&&drag.id===e.pointerId) move(e); });
      el.addEventListener('pointerup',()=>{drag=null;});
      function move(e){
        const r=drag.r;
        const x=clamp(e.clientX-r.left,0,r.width);
        const t=x/r.width;
        if(mode==="pitch") onSet((t*2)-1);
        else onSet(Math.round(t*127));
      }
    }

    function pulseBtn(el){
      el.classList.add('active');
      setTimeout(()=>el.classList.remove('active'),110);
    }

    function makeOsc(type){
      const o = audioCtx.createOscillator();
      o.type = type;
      return o;
    }

    function makeNoiseSource(){
      const len=audioCtx.sampleRate*0.35;
      const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<len;i++) data[i]=(Math.random()*2-1);
      const src=audioCtx.createBufferSource();
      src.buffer=buf;
      src.loop=true;
      return src;
    }

    function makePatch(id, freq, vel, mod, filter, now){
      const out = { oscA:null, oscB:null, src:null, peak:0.8*vel, sustain:0.18*vel, detuneMul:1 };
      const toFilter = (node)=>node.connect(filter);

      switch(id){
        case "sine": {
          const o=makeOsc("sine"); o.frequency.value=freq; toFilter(o); o.start(now);
          out.oscA=o; out.peak=0.75*vel; out.sustain=0.16*vel; return out;
        }
        case "tri": {
          const o=makeOsc("triangle"); o.frequency.value=freq; toFilter(o); o.start(now);
          out.oscA=o; out.peak=0.75*vel; out.sustain=0.15*vel; return out;
        }
        case "square": {
          const o=makeOsc("square"); o.frequency.value=freq; toFilter(o); o.start(now);
          out.oscA=o; out.peak=0.65*vel; out.sustain=0.12*vel; return out;
        }
        case "saw": {
          const o=makeOsc("sawtooth"); o.frequency.value=freq; toFilter(o); o.start(now);
          out.oscA=o; out.peak=0.8*vel; out.sustain=0.18*vel; return out;
        }
        case "supersaw": {
          const a=makeOsc("sawtooth"), b=makeOsc("sawtooth");
          a.frequency.value=freq; b.frequency.value=freq*1.0035; b.detune.value=7;
          toFilter(a); toFilter(b); a.start(now); b.start(now);
          out.oscA=a; out.oscB=b; out.detuneMul=1.0035; out.peak=0.75*vel; out.sustain=0.16*vel; return out;
        }
        case "pwm": {
          const a=makeOsc("square"), b=makeOsc("square");
          a.frequency.value=freq; b.frequency.value=freq*2; b.detune.value = 15 + mod*35;
          toFilter(a); toFilter(b); a.start(now); b.start(now);
          out.oscA=a; out.oscB=b; out.detuneMul=2; out.peak=0.7*vel; out.sustain=0.14*vel; return out;
        }
        case "fm_bell": {
          const carrier=makeOsc("sine"), modOsc=makeOsc("sine"), modGain=audioCtx.createGain();
          carrier.frequency.value=freq; modOsc.frequency.value=freq*2; modGain.gain.value = 60 + mod*220;
          modOsc.connect(modGain); modGain.connect(carrier.frequency);
          toFilter(carrier); carrier.start(now); modOsc.start(now);
          out.oscA=carrier; out.oscB=modOsc; out.peak=0.8*vel; out.sustain=0.06*vel; return out;
        }
        case "epiano": {
          filter.frequency.value = Math.min(filter.frequency.value, 4200);
          const carrier=makeOsc("triangle"), modOsc=makeOsc("sine"), modGain=audioCtx.createGain();
          carrier.frequency.value=freq; modOsc.frequency.value=freq*3; modGain.gain.value = 20 + mod*60;
          modOsc.connect(modGain); modGain.connect(carrier.frequency);
          toFilter(carrier); carrier.start(now); modOsc.start(now);
          out.oscA=carrier; out.oscB=modOsc; out.peak=0.75*vel; out.sustain=0.10*vel; return out;
        }
        case "organ": {
          filter.frequency.value = 9000; filter.Q.value = 0.6;
          const a=makeOsc("sine"), b=makeOsc("square");
          a.frequency.value=freq; b.frequency.value=freq*2;
          toFilter(a); toFilter(b); a.start(now); b.start(now);
          out.oscA=a; out.oscB=b; out.detuneMul=2; out.peak=0.65*vel; out.sustain=0.40*vel; return out;
        }
        case "strings": {
          filter.frequency.value = Math.min(filter.frequency.value, 2400 + mod*2400); filter.Q.value = 0.9;
          const a=makeOsc("sawtooth"), b=makeOsc("triangle");
          a.frequency.value=freq; b.frequency.value=freq*0.501; b.detune.value=-8;
          toFilter(a); toFilter(b); a.start(now); b.start(now);
          out.oscA=a; out.oscB=b; out.detuneMul=0.501; out.peak=0.55*vel; out.sustain=0.26*vel; return out;
        }
        case "voxpad": {
          filter.type="bandpass"; filter.frequency.value = 700 + mod*800; filter.Q.value = 4.5;
          const a=makeOsc("sawtooth"), b=makeOsc("sine");
          a.frequency.value=freq; b.frequency.value=freq*2;
          toFilter(a); toFilter(b); a.start(now); b.start(now);
          out.oscA=a; out.oscB=b; out.detuneMul=2; out.peak=0.55*vel; out.sustain=0.24*vel; return out;
        }
        case "pluck": {
          filter.frequency.value = 2200 + mod*5200; filter.Q.value = 1.1;
          const a=makeOsc("triangle"); a.frequency.value=freq; toFilter(a); a.start(now);
          const src=makeNoiseSource();
          const hp=audioCtx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=2200;
          src.connect(hp); hp.connect(filter); src.start(now);
          try{ src.stop(now+0.06); }catch(_){}
          out.oscA=a; out.src=src; out.peak=0.85*vel; out.sustain=0.05*vel; return out;
        }
        case "bass": {
          filter.frequency.value = 700 + mod*900; filter.Q.value = 1.2;
          const a=makeOsc("sawtooth"), b=makeOsc("sine");
          a.frequency.value=freq; b.frequency.value=freq/2;
          toFilter(a); toFilter(b); a.start(now); b.start(now);
          out.oscA=a; out.oscB=b; out.detuneMul=0.5; out.peak=0.70*vel; out.sustain=0.22*vel; return out;
        }
        case "sub": {
          filter.frequency.value = 500 + mod*500; filter.Q.value = 0.9;
          const a=makeOsc("sine"); a.frequency.value=freq; toFilter(a); a.start(now);
          out.oscA=a; out.peak=0.78*vel; out.sustain=0.30*vel; return out;
        }
        case "reese": {
          filter.frequency.value = 900 + mod*1400; filter.Q.value = 1.6;
          const a=makeOsc("sawtooth"), b=makeOsc("sawtooth");
          a.frequency.value=freq; b.frequency.value=freq*0.996; b.detune.value=-14;
          toFilter(a); toFilter(b); a.start(now); b.start(now);
          out.oscA=a; out.oscB=b; out.detuneMul=0.996; out.peak=0.65*vel; out.sustain=0.20*vel; return out;
        }
        case "brass": {
          filter.frequency.value = 1200 + mod*2200; filter.Q.value = 2.2;
          const a=makeOsc("square"), b=makeOsc("sawtooth");
          a.frequency.value=freq; b.frequency.value=freq*2;
          toFilter(a); toFilter(b); a.start(now); b.start(now);
          out.oscA=a; out.oscB=b; out.detuneMul=2; out.peak=0.78*vel; out.sustain=0.12*vel; return out;
        }
        case "glass": {
          filter.frequency.value = 4200 + mod*4200; filter.Q.value = 0.8;
          const carrier=makeOsc("sine"), modOsc=makeOsc("sine"), modGain=audioCtx.createGain();
          carrier.frequency.value=freq*2; modOsc.frequency.value=freq*5; modGain.gain.value = 25 + mod*90;
          modOsc.connect(modGain); modGain.connect(carrier.frequency);
          toFilter(carrier); carrier.start(now); modOsc.start(now);
          out.oscA=carrier; out.oscB=modOsc; out.peak=0.72*vel; out.sustain=0.05*vel; return out;
        }
        case "noiselead": {
          filter.frequency.value = 1600 + mod*5200; filter.Q.value = 1.0;
          const a=makeOsc("sawtooth"); a.frequency.value=freq;
          const src=makeNoiseSource();
          const bp=audioCtx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value = 1400 + mod*2200; bp.Q.value = 1.2;
          src.connect(bp); bp.connect(filter); toFilter(a);
          a.start(now); src.start(now);
          out.oscA=a; out.src=src; out.peak=0.70*vel; out.sustain=0.16*vel; return out;
        }
        case "chirp": {
          filter.frequency.value = 2600 + mod*5200; filter.Q.value = 0.9;
          const a=makeOsc("square"); a.frequency.value=freq; toFilter(a); a.start(now);
          out.oscA=a; out.peak=0.78*vel; out.sustain=0.08*vel; return out;
        }
        default: {
          const o=makeOsc("sawtooth"); o.frequency.value=freq; toFilter(o); o.start(now);
          out.oscA=o; out.peak=0.8*vel; out.sustain=0.18*vel; return out;
        }
      }
    }

    function keyDown(note,vel=0.9){
      pressedNotes.add(note);
      const el=keyElsByNote.get(note);
      if(el){ el.classList.add('active'); el.style.animation='none'; el.offsetHeight; el.style.animation=''; }
      if(!isAudioOn) return;
      if(activeVoices.has(note)) return;

      const now=audioCtx.currentTime;
      const baseF=midiToFreq(note)*Math.pow(2,pitchBend*(2/12));

      const filter=audioCtx.createBiquadFilter();
      filter.type='lowpass';

      const fNorm = (knobVals.get(MAP.knobCCs[1]) || 0) / 127;
      const rNorm = (knobVals.get(MAP.knobCCs[2]) || 0) / 127;

      const minF = 80;
      const maxF = 16000;
      const cutoff = minF * Math.pow(maxF / minF, fNorm);
      const resonance = 0.4 + Math.pow(rNorm, 1.6) * 18;

      filter.frequency.value = cutoff * (0.85 + vel * 0.3);
      filter.Q.value = resonance;

      const atk=0.002+((knobVals.get(MAP.knobCCs[3])||0)/127)*0.08;
      const dec=0.03+((knobVals.get(MAP.knobCCs[4])||0)/127)*0.50;
      const rel=0.02+((knobVals.get(MAP.knobCCs[5])||0)/127)*0.85;

      const mod = (modWheel/127);

      const amp=audioCtx.createGain();
      amp.gain.setValueAtTime(0.0001,now);

      const voice = makePatch(selectedSound, baseF, vel, mod, filter, now);

      const peak = voice.peak ?? (0.8*vel);
      const sustain = voice.sustain ?? (0.18*vel);

      amp.gain.exponentialRampToValueAtTime(Math.max(0.0002, peak), now+atk);
      amp.gain.exponentialRampToValueAtTime(Math.max(0.0002, sustain), now+atk+dec);

      filter.connect(amp);
      amp.connect(master);

      voice.release = rel;
      voice.amp = amp;
      voice.oscA.frequency.value = baseF;
      if(voice.oscB && voice.detuneMul) voice.oscB.frequency.value = baseF * voice.detuneMul;

      activeVoices.set(note, voice);
    }

    function keyUp(note){
      pressedNotes.delete(note);
      keyElsByNote.get(note)?.classList.remove('active');
      if(!isAudioOn) return;

      const v=activeVoices.get(note);
      if(!v) return;

      const now=audioCtx.currentTime;
      const rel=v.release ?? 0.35;

      try{
        v.amp.gain.cancelScheduledValues(now);
        v.amp.gain.setValueAtTime(Math.max(0.0002,v.amp.gain.value),now);
        v.amp.gain.exponentialRampToValueAtTime(0.0001, now+rel);
      }catch(_){}

      const stopAt = now + rel + 0.05;
      try{ v.oscA.stop(stopAt); }catch(_){}
      if(v.oscB) try{ v.oscB.stop(stopAt); }catch(_){}
      if(v.src) try{ v.src.stop(stopAt); }catch(_){}

      activeVoices.delete(note);
    }

    function padDown(note,vel=1.0,evt=null){
      pressedPads.add(note);
      const el=padElsByNote.get(note);
      if(el){
        el.classList.add('active');
        if(evt && evt.clientX!=null){
          const r=el.getBoundingClientRect();
          const rx=((evt.clientX-r.left)/r.width)*100;
          const ry=((evt.clientY-r.top)/r.height)*100;
          el.style.setProperty('--rx', rx.toFixed(2)+'%');
          el.style.setProperty('--ry', ry.toFixed(2)+'%');
        } else {
          el.style.setProperty('--rx','50%');
          el.style.setProperty('--ry','50%');
        }
        el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
        setTimeout(()=>el.classList.remove('pulse'),250);
      }
      if(isAudioOn) playDrum(el?.dataset.type||"perc",vel);
    }

    function padUp(note){
      pressedPads.delete(note);
      padElsByNote.get(note)?.classList.remove('active');
    }

    function noiseBuffer(){
      const len=audioCtx.sampleRate*0.2;
      const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<len;i++) data[i]=(Math.random()*2-1);
      return buf;
    }

    function playDrum(type,vel){
      const now=audioCtx.currentTime;
      const drumTone=80+((knobVals.get(MAP.knobCCs[6])||0)/127)*240;
      const drumDecay=0.04+((knobVals.get(MAP.knobCCs[7])||0)/127)*0.35;

      const out=audioCtx.createGain();
      out.gain.value = (loudMode ? 2.0 : 0.9) * vel;

      if(loudMode){
        const limiter = audioCtx.createDynamicsCompressor();
        limiter.threshold.value = -6;
        limiter.knee.value = 12;
        limiter.ratio.value = 6;
        limiter.attack.value = 0.002;
        limiter.release.value = 0.08;
        out.connect(limiter);
        limiter.connect(master);
      } else {
        out.connect(master);
      }

      function env(g,a,d){
        g.gain.setValueAtTime(0.0001,now);
        g.gain.exponentialRampToValueAtTime(1.0,now+a);
        g.gain.exponentialRampToValueAtTime(0.0001,now+a+d);
      }
      function filteredNoise(freq,q,dur){
        const src=audioCtx.createBufferSource();
        src.buffer=noiseBuffer();
        const f=audioCtx.createBiquadFilter();
        f.type='bandpass';
        f.frequency.value=freq;
        f.Q.value=q;
        const g=audioCtx.createGain();
        env(g,0.001,dur);
        src.connect(f); f.connect(g); g.connect(out);
        src.start(now); src.stop(now+dur+0.05);
      }

      const kit = currentKitKey;
      const kitBright = (kit==="neon") ? 1.15 : (kit==="glitch" ? 1.05 : 0.95);
      const kitDry    = (kit==="garage") ? 1.10 : 0.90;

      if(type.startsWith("kick")){
        const osc=audioCtx.createOscillator();
        osc.type="sine";
        const g=audioCtx.createGain();
        const startF=(type==="kick2")?130:160;
        const endF=(type==="gkick")?45:55;
        osc.frequency.setValueAtTime((startF+drumTone*0.15)*kitBright,now);
        osc.frequency.exponentialRampToValueAtTime(endF,now+(0.09+drumDecay*0.25));
        env(g,0.001,(0.18+drumDecay*0.55)*kitDry);
        osc.connect(g); g.connect(out);
        osc.start(now); osc.stop(now+0.6);
        if(type==="gkick") filteredNoise(900,1.2,0.06);
      } else if(type.includes("snare")){
        const osc=audioCtx.createOscillator();
        osc.type="triangle";
        osc.frequency.value=((type==="gsnare")?240:180)*kitBright;
        const g=audioCtx.createGain();
        env(g,0.001,(0.12+drumDecay*0.35)*kitDry);
        osc.connect(g); g.connect(out);
        osc.start(now); osc.stop(now+0.5);
        filteredNoise(((type==="snare2")?2200:3200)*kitBright,0.8,(0.14+drumDecay*0.35)*kitDry);
      } else if(type.includes("clap")){
        const src=audioCtx.createBufferSource();
        src.buffer=noiseBuffer();
        const bp=audioCtx.createBiquadFilter();
        bp.type="bandpass";
        bp.frequency.value=((type==="clap2")?1800:2400)*kitBright;
        bp.Q.value=0.9;
        const g=audioCtx.createGain();
        src.connect(bp); bp.connect(g); g.connect(out);

        const hits=[0,0.018,0.036,0.06];
        g.gain.setValueAtTime(0.0001,now);
        hits.forEach((t,i)=>{
          const peak=0.9/(1+i*0.35);
          g.gain.exponentialRampToValueAtTime(peak,now+t+0.001);
          g.gain.exponentialRampToValueAtTime(0.0001,now+t+0.03+(drumDecay*0.12)*kitDry);
        });
        src.start(now); src.stop(now+0.4);
      } else if(type.includes("hat")){
        const freq=type.includes("O")?6500:8000;
        const dur=type.includes("O")?(0.25+drumDecay*0.25):(0.06+drumDecay*0.12);
        filteredNoise(freq*kitBright,0.6,dur*kitDry);
      } else if(type.includes("tom")){
        const osc=audioCtx.createOscillator();
        osc.type="sine";
        const g=audioCtx.createGain();
        let f=140;
        if(type.includes("L")) f=110;
        if(type.includes("M")) f=160;
        if(type.includes("H")) f=220;
        if(type.endsWith("2")) f*=0.95;
        osc.frequency.value=(f+drumTone*0.12)*kitBright;
        env(g,0.002,(0.18+drumDecay*0.45)*kitDry);
        osc.connect(g); g.connect(out);
        osc.start(now); osc.stop(now+0.7);
        filteredNoise(1400*kitBright,0.7,0.04);
      } else if(type==="rim" || type==="rim2"){
        const osc=audioCtx.createOscillator();
        osc.type="square";
        osc.frequency.value=((type==="rim2")?1200:900)*kitBright;
        const g=audioCtx.createGain();
        env(g,0.001,(0.04+drumDecay*0.08)*kitDry);
        osc.connect(g); g.connect(out);
        osc.start(now); osc.stop(now+0.2);
      } else if(type.includes("crash") || type.includes("ride")){
        const dur=type.includes("ride")?(0.55+drumDecay*0.45):(0.85+drumDecay*0.55);
        filteredNoise((type.includes("ride")?5200:4300)*kitBright,0.5,dur*kitDry);
      } else {
        filteredNoise(2400*kitBright,1.2,(0.10+drumDecay*0.25)*kitDry);
      }
    }

    function panic(){
      if(isAudioOn){
        const now=audioCtx.currentTime;
        for(const [note,v] of activeVoices.entries()){
          try{
            v.amp.gain.cancelScheduledValues(now);
            v.amp.gain.setValueAtTime(0.0001,now);
            v.oscA.stop(now+0.02);
            if(v.oscB) v.oscB.stop(now+0.02);
            if(v.src) v.src.stop(now+0.02);
          }catch(_){}
        }
        activeVoices.clear();
      }
      pressedNotes.forEach(n=>keyElsByNote.get(n)?.classList.remove('active'));
      pressedPads.forEach(n=>padElsByNote.get(n)?.classList.remove('active'));
      pressedNotes.clear(); pressedPads.clear();
    }

    async function initMIDI(){
      if(!navigator.requestMIDIAccess) throw new Error("WebMIDI not supported");
      midiAccess=await navigator.requestMIDIAccess({sysex:false});
      midiAccess.onstatechange=refreshMidiInputs;
      refreshMidiInputs();
      midiDot.classList.add('on');
    }

    function refreshMidiInputs(){
      const inputs=Array.from(midiAccess.inputs.values());
      midiInSel.innerHTML='';
      const opt0=document.createElement('option');
      opt0.value='';
      opt0.textContent=inputs.length?'Select…':'No MIDI devices';
      midiInSel.appendChild(opt0);
      for(const input of inputs){
        const opt=document.createElement('option');
        opt.value=input.id;
        opt.textContent=input.name||`MIDI In ${input.id}`;
        midiInSel.appendChild(opt);
      }
      if(inputs.length && !midiIn){
        midiInSel.value=inputs[0].id;
        attachMidiIn(inputs[0].id);
      }
    }

    function attachMidiIn(id){
      if(midiIn) midiIn.onmidimessage=null;
      midiIn=midiAccess.inputs.get(id)||null;
      if(!midiIn) return;
      midiIn.onmidimessage=onMidiMsg;
    }

    function onMidiMsg(e){
      const [status,d1,d2]=e.data;
      const type=status & 0xF0;

      if(type===0x90){
        const note=d1, vel=d2;
        if(vel===0) handleNoteOff(note);
        else handleNoteOn(note, vel/127);
        return;
      }
      if(type===0x80){ handleNoteOff(d1); return; }

      if(type===0xB0){
        const cc=d1, val=d2;
        if(MAP.knobCCs.includes(cc)){ setKnob(cc,val); return; }
        if(cc===MAP.modCC){ setMod(val); return; }
        if(cc===MAP.play.number) pulseBtn(btnPlay);
        if(cc===MAP.stop.number) pulseBtn(btnStop);
        if(cc===MAP.rec.number) pulseBtn(btnRec);
        return;
      }

      if(type===0xE0){
        const v14=(d2<<7)|d1;
        const norm=(v14-8192)/8192;
        setPitch(norm);
        return;
      }
    }

    function handleNoteOn(note,vel){
      if(MAP.padNotes.includes(note)) padDown(note,vel,null);
      else keyDown(note,vel);
    }
    function handleNoteOff(note){
      if(MAP.padNotes.includes(note)) padUp(note);
      else keyUp(note);
    }

    const typingNoteMap=new Map([
      ["KeyA",0],["KeyW",1],["KeyS",2],["KeyE",3],["KeyD",4],["KeyF",5],["KeyT",6],
      ["KeyG",7],["KeyY",8],["KeyH",9],["KeyU",10],["KeyJ",11],["KeyK",12]
    ]);
    const typingPadMap=new Map([
      ["Digit1",0],["Digit2",1],["Digit3",2],["Digit4",3],
      ["KeyQ",4],["KeyW",5],["KeyE",6],["KeyR",7],
      ["KeyA",8],["KeyS",9],["KeyD",10],["KeyF",11],
      ["KeyZ",12],["KeyX",13],["KeyC",14],["KeyV",15]
    ]);
    const typingHeld=new Set();
    const typingBaseNote=()=>KEY_RANGE.start+(octaveOffset*12);

    function onKeyDown(e){
      if(e.repeat) return;
      if(e.code==="BracketLeft"){ octaveOffset=clamp(octaveOffset-1,-3,3); pulseBtn(octDown); return; }
      if(e.code==="BracketRight"){ octaveOffset=clamp(octaveOffset+1,-3,3); pulseBtn(octUp); return; }
      if(e.code==="Escape"){ panic(); return; }

      if(typingPadMap.has(e.code)){
        const idx=typingPadMap.get(e.code);
        const note=MAP.padNotes[idx];
        if(note!=null && !typingHeld.has("P"+e.code)){
          typingHeld.add("P"+e.code);
          padDown(note,1.0,null);
        }
        return;
      }

      if(typingNoteMap.has(e.code)){
        const semis=typingNoteMap.get(e.code);
        const note=typingBaseNote()+semis;
        if(!typingHeld.has(e.code)){
          typingHeld.add(e.code);
          keyDown(note,0.85);
        }
      }
    }

    function onKeyUp(e){
      if(typingPadMap.has(e.code)){
        const idx=typingPadMap.get(e.code);
        const note=MAP.padNotes[idx];
        typingHeld.delete("P"+e.code);
        if(note!=null) padUp(note);
        return;
      }
      if(typingNoteMap.has(e.code)){
        const semis=typingNoteMap.get(e.code);
        const note=typingBaseNote()+semis;
        typingHeld.delete(e.code);
        keyUp(note);
      }
    }

    startMidiBtn.addEventListener('click', async ()=>{
      try{ setAudioOn(true); await initMIDI(); splash.style.display='none'; }
      catch(err){ setAudioOn(true); splash.style.display='none'; }
    });
    startTypingBtn.addEventListener('click', ()=>{ setAudioOn(true); splash.style.display='none'; });

    midiInSel.addEventListener('change',(e)=>attachMidiIn(e.target.value));
    kitSel.addEventListener('change',()=>{ currentKitKey=kitSel.value; buildPads(); });
    soundSel.addEventListener('change',()=>{ selectedSound = soundSel.value; });
    loudToggle.addEventListener('change', e => { loudMode = e.target.checked; });

    octDown.addEventListener('click',()=>{ octaveOffset=clamp(octaveOffset-1,-3,3); pulseBtn(octDown); });
    octUp.addEventListener('click',()=>{ octaveOffset=clamp(octaveOffset+1,-3,3); pulseBtn(octUp); });

    panicBtn.addEventListener('click', panic);

    btnPlay.addEventListener('pointerdown',()=>pulseBtn(btnPlay));
    btnStop.addEventListener('pointerdown',()=>pulseBtn(btnStop));
    btnRec.addEventListener('pointerdown',()=>pulseBtn(btnRec));

    bindSlider(pitchEl,setPitch,"pitch");
    bindSlider(modEl,setMod,"mod");

    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('keyup', onKeyUp);

    buildSoundBank();
    buildKeyboard();
    buildPads();
    buildKnobs();
    setPitch(0);
    setMod(0);
  })();
  </script>
</body>
</html>
